<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xadrezinho â€” Lobby</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../visual/style.css" />
    <link rel="stylesheet" href="../visual/lobby.css" />
</head>

<body class="lobby-page">

    <!-- ===== BACKGROUND ===== -->
    <div class="lobby-bg">
        <div class="lobby-bg__img"></div>
        <div class="lobby-bg__overlay"></div>
        <div class="lobby-bg__particles" id="lobbyParticles"></div>
    </div>

    <!-- ===== NAVBAR ===== -->
    <nav class="navbar lobby-navbar">
        <a href="../index.html" class="nav-logo">
            <img src="../spritesxadrez/sprites/spr_rainha_verde.png" alt="Logo" class="nav-logo-img" />
            <span class="nav-logo-text">XADREZINHO</span>
        </a>

        <ul class="nav-links">
            <li><a href="../index.html" class="nav-link">InÃ­cio</a></li>
            <li><a href="lobby.html" class="nav-link active">Lobby</a></li>
            <li><a href="manual.html" class="nav-link">Manual</a></li>
        </ul>

        <div class="nav-actions lobby-nav-right">
            <!-- Player badge (TODO: populate from Supabase) -->
            <div class="player-badge">
                <img src="../spritesxadrez/sprites/spr_rainha_roxa.png" alt="Avatar" class="player-badge__avatar" />
                <div class="player-badge__info">
                    <span class="player-badge__name" id="playerName">Guerreiro</span>
                    <span class="player-badge__pts">
                        <img src="../spritesxadrez/sprites/spr_moeda.png" alt="pts" class="badge-coin" />
                        <span id="playerPts">0</span> pts
                    </span>
                </div>
            </div>
            <a href="login.html" class="btn-nav-login">Sair</a>
        </div>
    </nav>

    <!-- ===== MAIN LOBBY ===== -->
    <main class="lobby-main">

        <!-- Board decoration -->
        <img src="../spritesxadrez/sprites/spr_tabuleiro.png" alt="" class="lobby-board-deco" aria-hidden="true" />

        <!-- Header -->
        <div class="lobby-header">
            <p class="lobby-eyebrow">Bem-vindo Ã  arena</p>
            <h1 class="lobby-title">ESCOLHA <span class="accent-gold">SUA BATALHA</span></h1>
            <p class="lobby-subtitle">Selecione como deseja entrar em combate</p>
        </div>

        <!-- ===== MODE CARDS GRID ===== -->
        <div class="mode-grid">

            <!-- 1 â€” MATCHMAKING -->
            <div class="mode-card mode-card--online" id="cardMatchmaking">
                <div class="mode-card__bg"></div>
                <div class="mode-card__glow"></div>

                <div class="mode-card__top">
                    <div class="mode-card__icon-wrap">
                        <img src="../spritesxadrez/sprites/spr_rainha_verde.png" alt="" class="mode-card__icon" />
                    </div>
                    <span class="mode-badge mode-badge--online">ONLINE</span>
                </div>

                <div class="mode-card__body">
                    <h2 class="mode-card__title">PARTIDA RANQUEADA</h2>
                    <p class="mode-card__desc">
                        Entre na fila e enfrente um adversÃ¡rio aleatÃ³rio online.
                        Ganhe pontos e suba no ranking global.
                    </p>
                    <ul class="mode-card__tags">
                        <li>ğŸŒ Online</li>
                        <li>âš” 1 vs 1</li>
                        <li>ğŸ† Ranqueado</li>
                    </ul>
                </div>

                <button class="mode-card__btn" onclick="enterQueue()">
                    <span>ENTRAR NA FILA</span>
                    <span class="btn-play-shine"></span>
                </button>

                <!-- Queue status (shown when searching) -->
                <div class="queue-status" id="queueStatus" aria-live="polite">
                    <div class="queue-dots">
                        <span></span><span></span><span></span>
                    </div>
                    <span class="queue-text">Procurando adversÃ¡rio<span class="queue-ellipsis"></span></span>
                    <button class="queue-cancel" onclick="cancelQueue()">âœ• Cancelar</button>
                </div>
            </div>

            <!-- 2 â€” CRIAR SALA -->
            <div class="mode-card mode-card--create" id="cardCreate">
                <div class="mode-card__bg"></div>
                <div class="mode-card__glow"></div>

                <div class="mode-card__top">
                    <div class="mode-card__icon-wrap">
                        <img src="../spritesxadrez/sprites/spr_torre_verde.png" alt="" class="mode-card__icon" />
                    </div>
                    <span class="mode-badge mode-badge--private">PRIVADO</span>
                </div>

                <div class="mode-card__body">
                    <h2 class="mode-card__title">CRIAR SALA</h2>
                    <p class="mode-card__desc">
                        Gere um cÃ³digo exclusivo, compartilhe com seu amigo
                        e aguarde ele entrar para iniciar a batalha.
                    </p>
                    <ul class="mode-card__tags">
                        <li>ğŸ”— CÃ³digo Ãºnico</li>
                        <li>ğŸ‘¥ 2 jogadores</li>
                        <li>ğŸ•¹ Personalizado</li>
                    </ul>
                </div>

                <button class="mode-card__btn mode-card__btn--purple" onclick="createRoom()">
                    <span>CRIAR SALA</span>
                    <span class="btn-play-shine"></span>
                </button>

                <!-- Generated code display -->
                <div class="room-code-display" id="roomCodeDisplay">
                    <p class="room-code-label">Seu cÃ³digo de sala:</p>
                    <div class="room-code-box">
                        <span class="room-code-value" id="roomCodeValue">â€”â€”â€”â€”â€”â€”</span>
                        <button class="room-code-copy" onclick="copyCode()" title="Copiar cÃ³digo">â˜</button>
                    </div>
                    <p class="room-code-hint">Aguardando oponente entrar...</p>
                    <button class="queue-cancel" onclick="cancelRoom()">âœ• Cancelar sala</button>
                </div>
            </div>

            <!-- 3 â€” ENTRAR EM SALA -->
            <div class="mode-card mode-card--join" id="cardJoin">
                <div class="mode-card__bg"></div>
                <div class="mode-card__glow"></div>

                <div class="mode-card__top">
                    <div class="mode-card__icon-wrap">
                        <img src="../spritesxadrez/sprites/spr_cavalo_verde.png" alt="" class="mode-card__icon" />
                    </div>
                    <span class="mode-badge mode-badge--private">PRIVADO</span>
                </div>

                <div class="mode-card__body">
                    <h2 class="mode-card__title">ENTRAR EM SALA</h2>
                    <p class="mode-card__desc">
                        Tem o cÃ³digo do seu amigo? Digite abaixo e
                        entre diretamente na sala dele para o duelo.
                    </p>
                    <ul class="mode-card__tags">
                        <li>ğŸ”‘ CÃ³digo do amigo</li>
                        <li>ğŸ‘¥ 2 jogadores</li>
                        <li>âš¡ Direto ao ponto</li>
                    </ul>
                </div>

                <!-- Code input inline -->
                <div class="join-input-wrap">
                    <div class="join-field">
                        <input type="text" id="joinCodeInput" class="join-input" placeholder="Digite o cÃ³digo..."
                            maxlength="8" autocomplete="off" oninput="this.value=this.value.toUpperCase()" />
                        <button class="mode-card__btn mode-card__btn--gold" onclick="joinRoom()">
                            <span>ENTRAR</span>
                            <span class="btn-play-shine"></span>
                        </button>
                    </div>
                    <p class="join-msg" id="joinMsg"></p>
                </div>
            </div>

            <!-- 4 â€” LOCAL (Mesmo PC) -->
            <div class="mode-card mode-card--local" id="cardLocal">
                <div class="mode-card__bg"></div>
                <div class="mode-card__glow"></div>

                <div class="mode-card__top">
                    <div class="mode-card__icon-wrap">
                        <img src="../spritesxadrez/sprites/spr_peao_verde.png" alt="" class="mode-card__icon" />
                    </div>
                    <span class="mode-badge mode-badge--local">LOCAL</span>
                </div>

                <div class="mode-card__body">
                    <h2 class="mode-card__title">MESMO PC</h2>
                    <p class="mode-card__desc">
                        Jogue contra seu irmÃ£o, amigo ou prima no mesmo computador,
                        se revezando nas jogadas. Sem internet necessÃ¡ria.
                    </p>
                    <ul class="mode-card__tags">
                        <li>ğŸ–¥ Mesmo PC</li>
                        <li>ğŸ‘¤â†”ğŸ‘¤ Turnos</li>
                        <li>ğŸš« Sem internet</li>
                    </ul>
                </div>

                <a href="ingamelocal.html" class="mode-card__btn mode-card__btn--green" onclick="startLocal(event)">
                    <span>JOGAR AGORA</span>
                    <span class="btn-play-shine"></span>
                </a>
            </div>

        </div><!-- /mode-grid -->

        <!-- ===== BOTTOM STATS BAR ===== -->
        <div class="lobby-stats-bar">
            <div class="lb-stat">
                <span class="lb-stat__icon">ğŸŒ</span>
                <span class="lb-stat__val" id="onlinePlayers">â€”</span>
                <span class="lb-stat__lbl">jogadores online</span>
            </div>
            <div class="lb-stat-div"></div>
            <div class="lb-stat">
                <span class="lb-stat__icon">âš”</span>
                <span class="lb-stat__val" id="activeMatches">â€”</span>
                <span class="lb-stat__lbl">partidas ativas</span>
            </div>
            <div class="lb-stat-div"></div>
            <div class="lb-stat">
                <span class="lb-stat__icon">ğŸ†</span>
                <span class="lb-stat__val" id="totalMatches">â€”</span>
                <span class="lb-stat__lbl">partidas jogadas hoje</span>
            </div>
        </div>

    </main>

    <!-- ===== TOAST NOTIFICATION ===== -->
    <div class="toast" id="toast" aria-live="assertive"></div>

    <!-- ===== SCRIPT ===== -->
    <script>
        // --------------------------------------------------------
        //  PARTICLES
        // --------------------------------------------------------
        const pc = document.getElementById('lobbyParticles');
        for (let i = 0; i < 28; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.cssText = `
        left:${Math.random() * 100}vw;
        animation-delay:${Math.random() * 10}s;
        animation-duration:${8 + Math.random() * 9}s;
        width:${2 + Math.random() * 3}px;
        height:${2 + Math.random() * 3}px;
        opacity:${(0.1 + Math.random() * 0.4).toFixed(2)};
      `;
            pc.appendChild(p);
        }

        // --------------------------------------------------------
        //  MOCK STATS (TODO: replace with Supabase realtime)
        // --------------------------------------------------------
        document.getElementById('onlinePlayers').textContent = Math.floor(12 + Math.random() * 30);
        document.getElementById('activeMatches').textContent = Math.floor(4 + Math.random() * 14);
        document.getElementById('totalMatches').textContent = Math.floor(80 + Math.random() * 120);

        // --------------------------------------------------------
        //  TOAST HELPER
        // --------------------------------------------------------
        function toast(msg, type = 'info') {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.className = 'toast toast--' + type + ' toast--show';
            clearTimeout(el._t);
            el._t = setTimeout(() => el.classList.remove('toast--show'), 3200);
        }

        // --------------------------------------------------------
        //  1 â€” MATCHMAKING
        // --------------------------------------------------------
        let queueInterval = null;
        let queueSeconds = 0;

        function enterQueue() {
            const card = document.getElementById('cardMatchmaking');
            const qs = document.getElementById('queueStatus');
            card.classList.add('mode-card--searching');
            qs.classList.add('active');

            queueSeconds = 0;
            queueInterval = setInterval(() => {
                queueSeconds++;
                const txt = document.querySelector('.queue-text');
                if (txt) txt.dataset.sec = queueSeconds + 's';
            }, 1000);

            toast('Procurando adversÃ¡rio...', 'info');

            // TODO: connect to Supabase realtime matchmaking here
        }

        function cancelQueue() {
            clearInterval(queueInterval);
            const card = document.getElementById('cardMatchmaking');
            const qs = document.getElementById('queueStatus');
            card.classList.remove('mode-card--searching');
            qs.classList.remove('active');
            toast('Fila cancelada.', 'warn');
        }

        // --------------------------------------------------------
        //  2 â€” CRIAR SALA  (implementaÃ§Ã£o real no mÃ³dulo Supabase abaixo)
        //    O mÃ³dulo sobrescreve window.createRoom / cancelRoom / joinRoom
        // --------------------------------------------------------
        function createRoom() { /* aguarda mÃ³dulo carregar */ }
        function cancelRoom() { /* aguarda mÃ³dulo carregar */ }
        function joinRoom() { /* aguarda mÃ³dulo carregar */ }


        function copyCode() {
            const code = document.getElementById('roomCodeValue').textContent;
            navigator.clipboard.writeText(code).then(() => {
                toast('CÃ³digo copiado: ' + code, 'success');
            }).catch(() => {
                toast('NÃ£o foi possÃ­vel copiar. CÃ³digo: ' + code, 'warn');
            });
        }

        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
            return code;
        }


        // --------------------------------------------------------
        //  4 â€” LOCAL
        // --------------------------------------------------------
        function startLocal(e) {
            toast('Iniciando partida local...', 'success');
        }
    </script>


    <!-- ===== SUPABASE: session guard + player info + salas ===== -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const SUPABASE_URL = 'https://segetgqdxjwwkyjguzzo.supabase.co';
        const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlZ2V0Z3FkeGp3d2t5amd1enpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MzIyMjcsImV4cCI6MjA4NzIwODIyN30.4jM7c0mIyiTzpA9wkTOpLjyCWQ6taTab_OjToPx1o10';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

        // â”€â”€ Guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.replace('login.html'); }

        // â”€â”€ Perfil do jogador â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let myProfile = null;
        let myPartidaId = null;  // ID da partida criada (para cancelar)
        let roomSub = null;      // subscription Realtime da sala

        if (session) {
            const { data: profile } = await supabase
                .from('profiles')
                .select('id, username, pontos')
                .eq('id', session.user.id)
                .single();

            if (profile) {
                myProfile = profile;
                const nameEl = document.getElementById('playerName');
                const ptsEl = document.getElementById('playerPts');
                if (nameEl) nameEl.textContent = profile.username;
                if (ptsEl) ptsEl.textContent = profile.pontos.toLocaleString('pt-BR');
            }
        }

        // â”€â”€ BotÃ£o Sair â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.querySelector('.btn-nav-login')?.addEventListener('click', async (e) => {
            e.preventDefault();
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        });

        // â”€â”€ CRIAR SALA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.createRoom = async function () {
            if (!myProfile) { toast('VocÃª precisa estar logado.', 'warn'); return; }

            const code = generateCode();
            document.getElementById('roomCodeValue').textContent = code;
            document.getElementById('roomCodeDisplay').classList.add('active');
            document.getElementById('cardCreate').classList.add('mode-card--waiting');

            // Insere partida no Supabase
            const { data: partida, error } = await supabase
                .from('partidas')
                .insert({
                    jogador_branco: session.user.id,
                    jogador_preto: session.user.id, // placeholder â€” serÃ¡ trocado ao entrar
                    modo: 'privado',
                    codigo_sala: code,
                    status: 'aguardando'
                })
                .select()
                .single();

            if (error) { toast('Erro ao criar sala: ' + error.message, 'warn'); return; }

            myPartidaId = partida.id;
            toast('Sala criada! Compartilhe o cÃ³digo com seu amigo.', 'success');

            let redirected = false;
            let pollInterval = null; // declarado ANTES do closure
            const goToGame = () => {
                if (redirected) return;
                redirected = true;
                clearInterval(pollInterval);
                if (roomSub) { supabase.removeChannel(roomSub); roomSub = null; }
                window.location.href = `ingame.html?sala=${code}&cor=branco`;
            };

            // Tentativa 1 â€” Realtime
            roomSub = supabase
                .channel('sala_' + code)
                .on('postgres_changes', {
                    event: 'UPDATE', schema: 'public', table: 'partidas',
                    filter: `codigo_sala=eq.${code}`
                }, (payload) => {
                    const p = payload.new;
                    if (p.status === 'em_andamento' && p.jogador_preto !== session.user.id) goToGame();
                })
                .subscribe();

            // Tentativa 2 â€” Polling a cada 2 segundos (fallback principal)
            pollInterval = setInterval(async () => {
                try {
                    const { data: p } = await supabase
                        .from('partidas').select('status, jogador_preto')
                        .eq('id', partida.id).single();
                    if (p && p.status === 'em_andamento' && p.jogador_preto !== session.user.id) {
                        goToGame();
                    }
                } catch (e) { /* ignora erros de rede */ }
            }, 2000);

            // Guarda referÃªncia para que cancelRoom possa limpar o intervalo
            window._lobbyPollInterval = pollInterval;
        };


        // â”€â”€ CANCELAR SALA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.cancelRoom = async function () {
            document.getElementById('roomCodeDisplay').classList.remove('active');
            document.getElementById('cardCreate').classList.remove('mode-card--waiting');

            if (window._lobbyPollInterval) { clearInterval(window._lobbyPollInterval); window._lobbyPollInterval = null; }
            if (roomSub) { supabase.removeChannel(roomSub); roomSub = null; }
            if (myPartidaId) {
                await supabase.from('partidas').delete().eq('id', myPartidaId);
                myPartidaId = null;
            }
            toast('Sala cancelada.', 'warn');
        };

        // â”€â”€ ENTRAR EM SALA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.joinRoom = async function () {
            const input = document.getElementById('joinCodeInput');
            const msg = document.getElementById('joinMsg');
            const code = input.value.trim().toUpperCase();

            if (code.length < 4) {
                msg.textContent = 'Digite um cÃ³digo vÃ¡lido.';
                msg.className = 'join-msg join-msg--error';
                return;
            }

            msg.textContent = 'Verificando cÃ³digo...';
            msg.className = 'join-msg join-msg--info';

            // Busca partida pelo cÃ³digo
            const { data: partida, error } = await supabase
                .from('partidas')
                .select('id, status, jogador_branco')
                .eq('codigo_sala', code)
                .eq('status', 'aguardando')
                .single();

            if (error || !partida) {
                msg.textContent = 'Sala "' + code + '" nÃ£o encontrada ou jÃ¡ iniciada.';
                msg.className = 'join-msg join-msg--error';
                return;
            }

            if (partida.jogador_branco === session.user.id) {
                msg.textContent = 'VocÃª mesmo criou esta sala â€” compartilhe com um amigo!';
                msg.className = 'join-msg join-msg--error';
                return;
            }

            // Entra na sala â€” atualiza jogador_preto e status
            const { error: upErr } = await supabase
                .from('partidas')
                .update({ jogador_preto: session.user.id, status: 'em_andamento' })
                .eq('id', partida.id);

            if (upErr) {
                msg.textContent = 'Erro ao entrar na sala: ' + upErr.message;
                msg.className = 'join-msg join-msg--error';
                return;
            }

            // Redireciona como preto
            window.location.href = `ingame.html?sala=${code}&cor=preto`;
        };

        document.getElementById('joinCodeInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') window.joinRoom();
        });

    </script>


</body>

</html>